<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Canvas Chart.js</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .debug { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .chart-wrapper { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); 
            margin: 20px 0;
        }
        canvas { 
            border: 2px dashed #ccc; 
            max-width: 100%; 
            height: 350px !important;
        }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            margin: 10px 0; 
            border-left: 4px solid #007bff; 
            font-family: monospace; 
            font-size: 12px;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Canvas Chart.js</h1>
        
        <div class="debug">
            <h3>üìã Informa√ß√µes do Sistema</h3>
            <div id="systemInfo"></div>
        </div>

        <div class="debug">
            <h3>üìä Teste Canvas Simples</h3>
            <div class="chart-wrapper">
                <canvas id="simpleChart" width="600" height="300"></canvas>
            </div>
            <button onclick="createSimpleChart()">üîÑ Criar Gr√°fico Simples</button>
        </div>

        <div class="debug">
            <h3>üìà Teste API Integration</h3>
            <div class="chart-wrapper">
                <div id="apiChartContainer">
                    <!-- Aqui ser√° inserido o HTML da API -->
                </div>
            </div>
            <button onclick="testAPIChart()">üåê Testar API Chart</button>
        </div>

        <div class="debug">
            <h3>üìù Log de Debug</h3>
            <div id="debugLog"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            console.log(message);
            
            // Auto-scroll
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showSystemInfo() {
            const info = document.getElementById('systemInfo');
            info.innerHTML = `
                <p><strong>Chart.js:</strong> ${typeof Chart !== 'undefined' ? '‚úÖ Carregado' : '‚ùå N√£o carregado'}</p>
                <p><strong>Vers√£o Chart.js:</strong> ${typeof Chart !== 'undefined' ? Chart.version || 'Desconhecida' : 'N/A'}</p>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Canvas Support:</strong> ${document.createElement('canvas').getContext ? '‚úÖ Suportado' : '‚ùå N√£o suportado'}</p>
                <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
            `;
        }

        function createSimpleChart() {
            log('üéØ Iniciando cria√ß√£o de gr√°fico simples...');
            
            if (typeof Chart === 'undefined') {
                log('‚ùå Chart.js n√£o est√° carregado!', 'error');
                return;
            }

            const ctx = document.getElementById('simpleChart');
            if (!ctx) {
                log('‚ùå Canvas n√£o encontrado!', 'error');
                return;
            }

            // Destruir gr√°fico anterior se existir
            if (ctx.chart) {
                ctx.chart.destroy();
                log('üóëÔ∏è Gr√°fico anterior removido');
            }

            try {
                log('üìê Configurando gr√°fico...');
                
                const config = {
                    type: 'bar',
                    data: {
                        labels: ['A', 'B', 'C', 'D'],
                        datasets: [{
                            label: 'Dados de Teste',
                            data: [12, 19, 3, 17],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 205, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 205, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Teste de Canvas',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: '#e0e0e0' }
                            },
                            x: {
                                grid: { color: '#e0e0e0' }
                            }
                        },
                        animation: {
                            onComplete: function() {
                                log('‚úÖ Anima√ß√£o de gr√°fico conclu√≠da', 'success');
                            }
                        }
                    }
                };

                log('üöÄ Criando gr√°fico Chart.js...');
                ctx.chart = new Chart(ctx, config);
                log('‚úÖ Gr√°fico criado com sucesso!', 'success');

                // Verificar renderiza√ß√£o ap√≥s delay
                setTimeout(() => {
                    try {
                        const imageData = ctx.toDataURL();
                        log(`üìä Canvas renderizado: ${imageData.length} caracteres`, 'success');
                        
                        // Verificar se tem conte√∫do visual
                        if (imageData.length > 5000) {
                            log('‚úÖ Canvas parece ter conte√∫do visual!', 'success');
                        } else {
                            log('‚ö†Ô∏è Canvas pode estar vazio ou com pouco conte√∫do', 'error');
                        }
                    } catch (e) {
                        log(`‚ùå Erro ao verificar canvas: ${e.message}`, 'error');
                    }
                }, 1500);

            } catch (error) {
                log(`‚ùå Erro ao criar gr√°fico: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
            }
        }

        async function testAPIChart() {
            log('üåê Testando integra√ß√£o com API...');
            
            try {
                const testData = {
                    charts: [{
                        id: 'test-api-chart',
                        name: 'Teste API Chart',
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Fev', 'Mar', 'Abr'],
                            values: [10, 20, 15, 25]
                        },
                        description: 'Gr√°fico de teste da API',
                        referenceId: '[CHART:test-api]'
                    }]
                };

                log('üì§ Enviando requisi√ß√£o para API...');
                
                const response = await fetch('http://localhost:3002/api/process-charts-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (!response.ok) {
                    throw new Error(`API retornou status ${response.status}`);
                }

                const result = await response.json();
                log('‚úÖ Resposta da API recebida', 'success');

                if (result.chartHtml && result.chartHtml.length > 0) {
                    log('üìã Inserindo HTML do gr√°fico...');
                    document.getElementById('apiChartContainer').innerHTML = result.chartHtml[0];
                    log('‚úÖ HTML inserido com sucesso!', 'success');
                } else {
                    log('‚ùå Nenhum HTML de gr√°fico retornado', 'error');
                }

            } catch (error) {
                log(`‚ùå Erro na integra√ß√£o com API: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina carregada, iniciando debug...');
            showSystemInfo();
            
            // Aguardar Chart.js carregar
            if (typeof Chart === 'undefined') {
                log('‚è≥ Aguardando Chart.js carregar...');
                let attempts = 0;
                const checkChart = setInterval(() => {
                    attempts++;
                    if (typeof Chart !== 'undefined') {
                        log('‚úÖ Chart.js carregado!', 'success');
                        clearInterval(checkChart);
                        showSystemInfo();
                    } else if (attempts > 50) {
                        log('‚ùå Timeout: Chart.js n√£o carregou', 'error');
                        clearInterval(checkChart);
                    }
                }, 100);
            } else {
                log('‚úÖ Chart.js j√° carregado!', 'success');
            }
        });
    </script>
</body>
</html>
